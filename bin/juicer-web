#!/usr/bin/env python
import sys
import os
sys.path.insert(0, os.path.abspath('.'))
import web
import json
##############################################################################
# Routing

urls = (
    '/css/(.*\.css)', 'css',
    '/js/(.*\.js)', 'js',
    '/img/(.*)', 'img',
    # Get requests that accept a parameter:
    '/rest/juicer/list/(.+)', 'juicer_list',
    '/rest/juicer/list/?', 'juicer_list',
    # Plain GET requests here:
    '/rest/juicer/(.+)', 'juicer_rest',
    '(.*)', 'static',
    )

app = web.application(urls, globals())


##############################################################################
class juicer_list:
    def GET(self, glob='*'):
        import juicer.juicer.Parser
        parser = juicer.juicer.Parser.Parser()
        args = parser.parser.parse_args(['list', glob])
        juicer.utils.Log.LOG_LEVEL_CURRENT = 0
        result = args.j(args)
        web.header('Content-Type', 'application/json')
        return json.dumps(result)

##############################################################################
class juicer_rest:
    def GET(self, action):
        import juicer.juicer.Parser
        parser = juicer.juicer.Parser.Parser()

        if action == 'hello':
            args = parser.parser.parse_args(['hello'])
        elif action == 'list':
            args = parser.parser.parse_args(['list'])
        else:
            pass

        juicer.utils.Log.LOG_LEVEL_CURRENT = 0
        result = args.j(args)
        web.header('Content-Type', 'application/json')
        return json.dumps(result)

##############################################################################
class img:
    def GET(self, path):
        if path.endswith('gif'):
            type = 'gif'
        elif path.endswith('jpg'):
            type = 'jpeg'
        elif path.endswith('png'):
            type ='png'
        else:
            print "WTF? %s" % path

        web.header('Content-Type', 'image/%s' % type)
        return open('./static/img/%s' % path, 'r').read()

##############################################################################
class js:
    def GET(self, path):
        web.header('Content-Type', 'text/javascript')
        return open('./static/js/%s' % path, 'r').read()

##############################################################################
class css:
    def GET(self, path):
        web.header('Content-Type', 'text/css')
        return open('./static/css/%s' % path, 'r').read()


##############################################################################
class static:
    def GET(self, path):
        web.header('Content-Type', 'text/html')
        return open('./static/index.html', 'r').read()


##############################################################################
if __name__ == "__main__":
    app.run()
